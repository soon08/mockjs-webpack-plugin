"use strict";var fs=require("fs"),path=require("path"),Mock=require("mockjs"),Random=Mock.Random,template=fs.readFileSync(path.join(__dirname,"doc.html"),"utf8"),_require=require("./util"),cleanCache=_require.cleanCache,isJavacriptFile=_require.isJavacriptFile,parseAPIs=require("./mock");function mock(u){return function(e,r,t){var a=parseAPIs(u);r.set("Access-Control-Allow-Origin","*"),r.set("Access-Control-Allow-Methods","GET,HEAD,PUT,POST,DELETE,PATCH");var o=e.headers["access-control-request-headers"];if(o&&r.set("Access-Control-Allow-Headers",o),"OPTIONS"===e.method)return r.send("");var c=e.url.split("?")[0],i=a[c]||{};if(mock.debug&&console.log("url: "+c),"/"===c){var n=e.protocol+"://"+e.headers.host+e.baseUrl,s=Object.keys(a).sort().map(function(r){if(isJavacriptFile(r))a[r].data=require(r);else try{a[r].data=new Function("return ("+a[r].content+")")()}catch(e){delete a[r],console.warn("[Mock Warn]:",e)}var e=a[r];return{title:e.describe,url:n+e.url,file:e.filepath}});return r.end(template.replace("@menuList",JSON.stringify(s)))}var l=i.data;if(isJavacriptFile(i.filepath))cleanCache(require.resolve(i.filepath)),l=require(i.filepath);else try{l=new Function("return ("+i.content+")")()}catch(e){delete a[pathname],console.warn("[Mock Warn]:",e)}l?("function"==typeof l&&(l=l(e,Mock,Random)),r.json(Mock.mock(l))):t()}}mock.debug=!0,module.exports={mock:mock};